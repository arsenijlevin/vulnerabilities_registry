import { NextRequest, NextResponse } from 'next/server';

import { Prisma } from '@prisma/prismadb';
import {
  getVulnerabilityById,
  getAllVulnerabilities,
  deleteVulnerabilityById,
  updateVulnerability,
  createVulnerability,
} from '../handlers';

import { VulnerabilityDTO, VulnerabilityTable } from '@/dto/VulnerabilityDTO';

interface VulnerabilityParamsGET {
  params: {
    id: string;
  };
}

export type SingleVulnerability = Prisma.PromiseReturnType<typeof getVulnerabilityById>;

export async function GET(request: NextRequest, { params }: VulnerabilityParamsGET) {
  const vulnerabilities = !params.id
    ? await getVulnerabilitiesWithFiltering(request)
    : await getVulnerabilityById(+params.id);

  return NextResponse.json(vulnerabilities);
}

export async function POST(request: NextRequest) {
  const body = (await request.json()) as VulnerabilityTable;
  const data = new VulnerabilityDTO().fromTable(body).toVulnerability();

  const vulnerabilities = await createVulnerability(data);

  return NextResponse.json(vulnerabilities, {
    status: 201,
  });
}

export async function PUT(request: NextRequest, { params }: VulnerabilityParamsGET) {
  const body = (await request.json()) as VulnerabilityTable;
  const data = new VulnerabilityDTO().fromTable(body).toVulnerability();

  const vulnerabilities = await updateVulnerability(+params.id, data);

  return NextResponse.json(vulnerabilities);
}

export async function DELETE(request: NextRequest, { params }: VulnerabilityParamsGET) {
  const location = await deleteVulnerabilityById(+params.id);

  return NextResponse.json(location);
}

export type VulnerabilityFilter = 'hardware' | 'location';

async function getVulnerabilitiesWithFiltering(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const hardwareId = searchParams.get('hardware');
  const locationId = searchParams.get('location');

  return await getAllVulnerabilities(hardwareId, locationId);
}
